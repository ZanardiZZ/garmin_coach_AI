#!/bin/bash
# pre-commit hook - Roda testes unit√°rios antes de permitir commit

set -e

echo "üîç Rodando testes unit√°rios antes do commit..."

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Detecta diret√≥rio raiz do projeto
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Verifica se BATS est√° instalado
if ! command -v bats &>/dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  BATS n√£o instalado. Pulando testes Bash.${NC}"
  echo "   Para instalar: ./tests/install_deps.sh"
  SKIP_BASH=true
fi

# Verifica se Node.js est√° instalado
if ! command -v node &>/dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  Node.js n√£o instalado. Pulando testes Node.js.${NC}"
  SKIP_NODE=true
fi

# Roda testes unit√°rios Bash
if [[ "${SKIP_BASH:-}" != "true" ]]; then
  echo "  ‚Üí Testes unit√°rios Bash..."
  if ! make test-unit-bash >/dev/null 2>&1; then
    echo -e "${RED}‚ùå Testes unit√°rios Bash falharam!${NC}"
    echo ""
    echo "   Execute 'make test-unit-bash' para ver os erros."
    echo "   Para commitar mesmo assim: git commit --no-verify"
    exit 1
  fi
  echo -e "${GREEN}  ‚úÖ Testes unit√°rios Bash passaram${NC}"
fi

# Roda testes Node.js
if [[ "${SKIP_NODE:-}" != "true" && -d fit/node_modules ]]; then
  echo "  ‚Üí Testes Node.js..."
  if ! (cd fit && npm test --silent) >/dev/null 2>&1; then
    echo -e "${RED}‚ùå Testes Node.js falharam!${NC}"
    echo ""
    echo "   Execute 'cd fit && npm test' para ver os erros."
    echo "   Para commitar mesmo assim: git commit --no-verify"
    exit 1
  fi
  echo -e "${GREEN}  ‚úÖ Testes Node.js passaram${NC}"
fi

echo -e "${GREEN}‚úÖ Todos os testes passaram! Commit permitido.${NC}"
exit 0
