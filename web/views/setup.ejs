<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ultra Coach - Setup</title>
    <link rel="stylesheet" href="/public/style.css" />
  </head>
  <body>
    <div class="bg-grid"></div>
    <header class="header">
      <div class="brand">
        <div class="brand-mark">UC</div>
        <div class="brand-text">
          <div class="brand-title">Ultra Coach</div>
          <div class="brand-sub">Configuracao inicial</div>
        </div>
      </div>
      <a class="btn" href="/">Dashboard</a>
    </header>

    <main class="grid">
      <section class="card">
        <div class="card-title">Credenciais</div>
        <form id="setup-form" class="form" method="post" action="/setup">
          <div class="form-group">
            <label>OpenAI API Key</label>
            <input name="openai_api_key" type="password" value="<%= config.OPENAI_API_KEY || '' %>" />
          </div>
          <div class="form-group">
            <label>Modelo</label>
            <input name="model" type="text" value="<%= config.MODEL || 'gpt-5' %>" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Telegram Token</label>
              <input name="telegram_token" type="password" value="<%= config.TELEGRAM_BOT_TOKEN || '' %>" />
            </div>
            <div class="form-group">
              <label>Telegram Chat ID</label>
              <input name="telegram_chat_id" type="text" value="<%= config.TELEGRAM_CHAT_ID || '' %>" />
            </div>
          </div>
          <div class="card-title">Garmin Connect</div>
          <div class="form-row">
            <div class="form-group">
              <label>Garmin Email</label>
              <input name="garmin_email" type="email" value="<%= config.GARMINCONNECT_EMAIL || '' %>" />
            </div>
            <div class="form-group">
              <label>Garmin Password</label>
              <input name="garmin_password" type="password" value="<%= config.GARMINCONNECT_PASSWORD || '' %>" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Garmin China Account</label>
              <select name="garmin_is_cn">
                <option value="false" <%= config.GARMINCONNECT_IS_CN === 'false' ? 'selected' : '' %>>nao</option>
                <option value="true" <%= config.GARMINCONNECT_IS_CN === 'true' ? 'selected' : '' %>>sim</option>
              </select>
            </div>
            <div class="form-group">
              <label>Token Dir</label>
              <input name="garmin_token_dir" type="text" value="<%= config.GARMIN_TOKEN_DIR || '~/.ultra-coach/garminconnect' %>" />
            </div>
            <div class="form-group">
              <label>Sync Days</label>
              <input name="garmin_sync_days" type="number" min="1" max="180" value="<%= config.GARMIN_SYNC_DAYS || 7 %>" />
            </div>
          </div>
          <div class="form-group">
            <label>Detalhar atividades (GPS/FC)</label>
            <select name="garmin_fetch_activity_details">
              <option value="true" <%= (config.GARMIN_FETCH_ACTIVITY_DETAILS || 'true') === 'true' ? 'selected' : '' %>>sim</option>
              <option value="false" <%= config.GARMIN_FETCH_ACTIVITY_DETAILS === 'false' ? 'selected' : '' %>>nao</option>
            </select>
          </div>

          <div class="card-title">Atletas</div>
          <div class="form-row">
            <div class="form-group">
              <label>Quantidade de atletas</label>
              <input id="athlete-count" name="athlete_count" type="number" min="1" max="10" value="<%= Math.max(athletes.length, 1) %>" />
            </div>
          </div>

          <div id="athletes"></div>

          <button class="btn primary" type="submit">Salvar configuracao</button>
        </form>
      </section>
      <section class="card">
        <div class="card-title">Resumo Semanal</div>
        <div class="form-group">
          <label>Dia da semana para enviar</label>
          <select name="weekly_summary_day" form="setup-form">
            <option value="1" <%= config.WEEKLY_SUMMARY_DAY === '1' ? 'selected' : '' %>>segunda</option>
            <option value="2" <%= config.WEEKLY_SUMMARY_DAY === '2' ? 'selected' : '' %>>terca</option>
            <option value="3" <%= config.WEEKLY_SUMMARY_DAY === '3' ? 'selected' : '' %>>quarta</option>
            <option value="4" <%= config.WEEKLY_SUMMARY_DAY === '4' ? 'selected' : '' %>>quinta</option>
            <option value="5" <%= config.WEEKLY_SUMMARY_DAY === '5' ? 'selected' : '' %>>sexta</option>
            <option value="6" <%= config.WEEKLY_SUMMARY_DAY === '6' ? 'selected' : '' %>>sabado</option>
            <option value="7" <%= config.WEEKLY_SUMMARY_DAY === '7' ? 'selected' : '' %>>domingo</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Horario (HH:MM)</label>
            <input name="weekly_summary_time" form="setup-form" type="text" value="<%= config.WEEKLY_SUMMARY_TIME || '07:00' %>" />
          </div>
          <div class="form-group">
            <label>Fuso horario (perfil e resumo)</label>
            <input name="weekly_summary_tz" form="setup-form" type="text" value="<%= config.WEEKLY_SUMMARY_TZ || 'America/Sao_Paulo' %>" />
          </div>
        </div>
      </section>
    </main>

    <script>
      const athletes = <%- JSON.stringify(athletes || []) %>;
      const container = document.getElementById('athletes');
      const countInput = document.getElementById('athlete-count');

      function renderAthletes() {
        const count = Math.max(1, Number(countInput.value || 1));
        container.innerHTML = '';
        for (let i = 0; i < count; i += 1) {
          const a = athletes[i] || {};
          const idx = i + 1;
          const block = document.createElement('div');
          block.className = 'athlete-block';
          block.innerHTML = `
            <input type="hidden" name="athlete_id_${idx}" value="${a.athlete_id || ''}" />
            <div class="form-row">
              <div class="form-group">
                <label>Nome</label>
                <input name="name_${idx}" type="text" value="${a.name || ''}" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>FC max</label>
                <input name="hr_max_${idx}" type="number" min="100" max="230" value="${a.hr_max || ''}" required />
              </div>
              <div class="form-group">
                <label>FC repouso</label>
                <input name="hr_rest_${idx}" type="number" min="30" max="100" value="${a.hr_rest || 50}" />
              </div>
              <div class="form-group">
                <label>Coach mode</label>
                <select name="coach_mode_${idx}">
                  <option value="conservative" ${a.coach_mode === 'conservative' ? 'selected' : ''}>conservative</option>
                  <option value="moderate" ${!a.coach_mode || a.coach_mode === 'moderate' ? 'selected' : ''}>moderate</option>
                  <option value="aggressive" ${a.coach_mode === 'aggressive' ? 'selected' : ''}>aggressive</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Objetivo</label>
                <input name="goal_${idx}" type="text" value="${a.goal_event || ''}" />
              </div>
              <div class="form-group">
                <label>Horas/semana</label>
                <input name="weekly_hours_${idx}" type="number" step="0.5" min="0" value="${a.weekly_hours_target || ''}" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Peso (kg)</label>
                <input name="weight_kg_${idx}" type="number" step="0.1" min="0" value="${a.weight_kg || ''}" />
              </div>
              <div class="form-group">
                <label>LT Pace (min/km)</label>
                <input name="lt_pace_${idx}" type="number" step="0.01" min="0" value="${a.lt_pace_min_km || ''}" />
              </div>
              <div class="form-group">
                <label>LT FC (bpm)</label>
                <input name="lt_hr_${idx}" type="number" min="0" value="${a.lt_hr || ''}" />
              </div>
              <div class="form-group">
                <label>LT Power (W)</label>
                <input name="lt_power_${idx}" type="number" step="1" min="0" value="${a.lt_power_w || ''}" />
              </div>
            </div>
          `;
          container.appendChild(block);
        }
      }

      countInput.addEventListener('input', renderAthletes);
      renderAthletes();
    </script>
  </body>
</html>
